- @RestClientTest 학습
- MockRestServiceServer
- MockServerClientCustomizer 학습
- 반드시 빈 주입할 때 RestClient.Builder를 사용할 것

HTTP API 요청을 테스트 하는 방법?

---

#### 이슈 1. RequestFactory를 프로덕션에서 주입하면 테스트 코드 모킹이 더 이상 작동하지 않음 
(해설)
1. ClientHttpRequestFactory를 통해서 RestClient가 HTTP Requst를 생성한다. (저수준)  
2. MockRestServiceServer는 1번의 객체를 Mock으로 치환해서, 요청을 검증하는 작업을 수행한다.  
3. 하지만, 내가 생성자에서 직접 이 Factory를 restClientBuilder에 setter 해주면, 이 Mock으로 치환된 값이 다시 덮어씌워진다.  
4. 즉, 모킹이 안되고 있는 문제가 존재한다.  
5. 그래서, 내가 timeout 설정을 해도 실제 서버로 요청이 나가기 때문에 에러가 발생한 것이다.

#### 해결법
1. RestClientCustomizer 를 Bean으로 주입해서, RestClient.Builder에 전역 설정을 적용할 수 있음 (Spring의 Autoconfiguration 과정에서 RestClientCustomizer의 빈 등록을 감지하고, 전역 설정을 적용해줌)
2. 그러면 프로덕션 클래스의 생성자에서, Factory로 timeout 세팅하는 부분을 생략해도 RestClient에 Builder 설정이 적용된다.
3. 따라서, 우회적으로 위 문제를 해결할 수 있다.
4. 이 모든 걸 간략하게 application.yml 에 timeout 설정 옵션이 존재함 ..
---



# Prolog
외부 API 연동을 위해 선택한 HTTP Client는 무엇이며, 선택 기준은 무엇이었나요? 다시 선택한다면 다른 결정을 내릴 수도 있을 것 같은가요?
> API 연동을 위해 선택한 HTTP Client는 RestClient 입니다. 다양한 선택지 속에서 가장 범용적이고 사용하기 쉬운 라이브러리로 RestTemplate과 RestClient가 있었는데요. RestTemplate은 오래된 방식의 동기 HTTP 클라이언트로, 메서드 호출 방식이 비교적 장황하고 설정에 유연성이 떨어지는 반면, RestClient는 선언적이고 간결한 fluent API 스타일로 직관적이며 유지보수가 용이하다고 판단해 선택했습니다. 다시 선택해도 동일한 결정을 내릴 것 같습니다.

외부 API의 응답이 지연되거나, 일시적으로 요청에 실패할 경우 어떻게 대응하도록 설계했나요? 이러한 설계에서 사용자는 어떤 경험을 하게 되나요?
> 토스 API 요청에 대한 connection time out은 3초, read time out은 30초로 설정했습니다. read time out의 경우 토스 공식 docs의 자료를 참고해서 선정했습니다. 만약 일시적으로 요청에 실패하거나, 응답이 30초 이상 지연되는 경우 Bad Request 코드와 함께 "일시적인 문제가 발생했습니다, 다시 시도해주세요." 라는 메시지를 받게 됩니다. 사용자의 경우 정확한 설명이 없기 때문에 당황스러울 수 있지만, API 응답 지연의 경우 서버 선에서 처리할 수 있는 것이 없기 때문에, 이러한 에러 처리 방식이 최선이라고 판단했습니다.

외부 API 연동 로직을 어떻게 테스트했나요? 선택한 테스트 방식(Mock, 실제 API호출 등)의 장단점은 무엇인가요? 테스트 속도,비용, 안정성 측면에서 어떤 점을 고려하여 결정했나요?
> 토스 결제 API를 실제로 호출하여 테스트 하는 방식은 불가능합니다. 따라서, @RestClientTest로 RestClient 관련 Bean만을 로드하고, MockRestServiceServer를 사용해서 RestClient 가 응답을 보낼 때 사용하는 ClientHttpRequestFactory를 MockClientHttpRequestFactory 대체하는 방식으로 모킹했습니다. 따라서 실제 API 요청은 보내지 않지만, 각 상황에 대한 Exception Handling 테스트는 모두 작성했습니다. 이 방법을 제외하고 다른 방법은 잘 생각나지 않아서, 속도, 비용, 안정성 측면에서 다른 방식과 비교한 점은 없습니다.