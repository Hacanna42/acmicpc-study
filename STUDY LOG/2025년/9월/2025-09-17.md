# TO DO
- [x] 구구의 Tomcat 구현 미션 (현재 4/4단계) ✅ 2025-09-17
	- [x] Http Request 리팩터링 ✅ 2025-09-13
	- [x] Http Response 리팩터링 ✅ 2025-09-14
	- [x] Controller 인터페이스 추가 ✅ 2025-09-14
	- [x] Thread pool 구현 ✅ 2025-09-17
- [x] Reflection API 학습 테스트 진행 ✅ 2025-09-17
- [x] Servlet과 Servlet Container 퀘스트 진행 ✅ 2025-09-17
- [ ] Grafana + Prometheus + Grafana Loki + Spring Actuator 셋업
- [ ] @MVC 구현 미션 (현재 1/3단계)
- [ ] 몽이 MVC 구현 미션 리뷰
- [ ] 취준


---

# 모니터링 작업 할 일
# Task

- [x] EC2 생성
- [x] Prometheus 설치
    - [x] Prometheus 현 개발서버에 꽂아보자
    - [x] Actuator 설정
    - [x] 각 서버별 라벨설정
- [x] Grafana 설치
- [x] Grafana 설정 및 대시보드 구성(대충)
- [ ] 운영 / 개발 / 부하테스트. 총 3개의 서버에 대해 target
- [x] Grafana loki 추가
- [ ] OpenTelemetry SDK 추가 작업
- [ ] Grafana Tempo 연동 및 Traces 시각화 패널 적용


---

# 오늘 한 일 요약
- 레오와 모니터링 시스템 셋업에 시간을 모두 썼다.
- 최종적으로 Actuator + Grafana + Prometheus + Loki 구성을 완료했다.
- 내일은 OpenTelemetry를 프로젝트에 세팅, Grafana Tempo를 사용 할 예정.
- 이미 Grafana Loki가 저장하는 로그에 traceId와 소요 시간이 기록되고 있다. 그런데도 왜 분산 추적 저장소인 Tempo를 사용해야 하는지에 대한 이유를 찾느라 약 1시간이 소요되었다.
- 결론적으로, Grafana의 시각화 패널 중 하나인 Traces는 Grafana Tempo data source가 있어야만 사용할 수 있다는 사실을 [공식 문서](https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/)에서 확인했다.




# 지금까지의 작업 내역

### **1. EC2 환경 준비**

- **인스턴스 생성**: photogather-monitoring (t4g.small)
- **도커 설치** 완료

### **2. Prometheus 설치 및 실행**

1. **이미지 다운로드**
2. **컨테이너 실행**

```jsx
sudo docker run --name prometheus -d -p 8080:9090 prom/prometheus
```

## 3. docker-compose 설정

```markdown
sudo docker compose ps -a

sudo docker compose up -d

sudo docker compose stop prometheus
```

### **3. Grafana 설치 및 실행**

1. **이미지 다운로드**
2. 컨테이너 실행

```jsx
sudo docker run -d -p 8080:3000 --name=grafana grafana/grafana-oss
```

### 4. Grafana + Prometheus 연동 및 대시보드 구성

Grafana와 Prometheus는 하나의 `docker-compose.yml` 에 정의되어 같은 컴포즈 프로젝트 내에 실행되어있다. 도커 컴포즈 프로젝트 내의 컨테이너들은 network 설정이 되어있고, 도커 DNS를 통해 서로에게 접근할 수 있다. 덕분에 Grafana와 Prometheus의 연동은 어렵지 않았다.

### 5. Grafana Loki 및 Promtail 구성

Prometheus는 Spring Actuator + Micrometer 구성으로 메트릭 정보를 얻는다.

Grafana Loki는 Promtail Agent를 통해 WAS의 로그 정보를 얻는다.

Grafana는 Prometheus(Data source)로 메트릭 정보를 얻고, Loki로 로그 정보를 얻는다.

최종적으로 Grafana GUI 에서 서버를 모두 모니터링 할 수 있다.

**중요 사항: Grafana Tempo에 대해 잘못 이해하고 있음. TraceId 발급의 주체가 아님. Grafana Tempo 적용 논의 전에 OpenTelemetry에 대해 공부할 것. **


## **2. 지금 사용 중인 방식 (수동 traceId 생성 + 로그)**

- 장점: 간단함. 로그에 traceId만 찍으면 특정 요청 흐름을 grep으로 추적 가능.
    
- 한계:
    
    1. **전파(Propagation)**
        
        - 외부 API 호출할 때 직접 traceId를 헤더에 넣고, 응답 쪽에서도 다시 로그에 찍도록 **수작업 구현** 필요.
            
        - 여러 서비스로 확장되면 관리가 복잡해짐.
            
        
    2. **Span 개념 없음**
        
        - 지금은 요청 전체에 단일 traceId만 있고, 메서드/DB 호출별로 걸린 시간(span 단위)이 자동 기록되지 않음.
            
        
    3. **표준 외부 도구와 연계 어려움**
        
        - Prometheus/Grafana Tempo/Jaeger 같은 도구와 “자동 연계”가 안 됨.
            
        - 즉, 로그는 로그대로, 메트릭은 메트릭대로 따로 봐야 함.
            
        
    

---

## **3. OpenTelemetry 방식**

- 요청 들어올 때 **자동으로 traceId + spanId 생성**
    
- 프레임워크 수준에서 **컨트롤러 → 서비스 → DB → 외부 API 호출** 까지 span이 쪼개져 기록됨
    
- 각 span에는 속성(attributes, 예: uri=/api/users, status=200, db.statement=SELECT ...) 이 붙음
    
- Exporter로 내보내면 Tempo/Jaeger에서 **워터폴 차트**로 한눈에 요청 흐름과 병목 구간 확인 가능
    
- **전파(propagation)** 도 자동 처리: 예를 들어 S3 호출 시 HTTP 헤더에 traceId/spanId 자동 삽입



---

### Grafana Tempo를 사용해야 하는 이유
Grafana 의 시각화 패널 중 하나인 Traces는, Data source가 Grafana Tempo여야만 사용할 수 있다.
[https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/](https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/)



---


# 작업 내역

### **1. EC2 환경 준비**

- **인스턴스 생성**: photogather-monitoring (t4g.small)
- **도커 설치** 완료

### **2. Prometheus 설치 및 실행**

1. **이미지 다운로드**
2. **컨테이너 실행**

```jsx
sudo docker run --name prometheus -d -p 8080:9090 prom/prometheus
```

## 3. docker-compose 설정

```markdown
sudo docker compose ps -a

sudo docker compose up -d

sudo docker compose stop prometheus
```

### **3. Grafana 설치 및 실행**

1. **이미지 다운로드**
2. 컨테이너 실행

```jsx
sudo docker run -d -p 8080:3000 --name=grafana grafana/grafana-oss
```

### 4. Grafana + Prometheus 연동 및 대시보드 구성

Grafana와 Prometheus는 하나의 `docker-compose.yml` 에 정의되어 같은 컴포즈 프로젝트 내에 실행되어있다. 도커 컴포즈 프로젝트 내의 컨테이너들은 network 설정이 되어있고, 도커 DNS를 통해 서로에게 접근할 수 있다. 덕분에 Grafana와 Prometheus의 연동은 어렵지 않았다.

### 5. Grafana Loki 및 Promtail 구성

Prometheus는 Spring Actuator + Micrometer 구성으로 메트릭 정보를 얻는다.

Grafana Loki는 Promtail Agent를 통해 WAS의 로그 정보를 얻는다.

Grafana는 Prometheus(Data source)로 메트릭 정보를 얻고, Loki로 로그 정보를 얻는다.

최종적으로 Grafana GUI 에서 서버를 모두 모니터링 할 수 있다.

Promtail은 WAS가 있는 서버에 설치되어있는 Agent다.

실행 방법은 `/home/ubuntu/promtail/start_promtail.sh`

grafana의 visualization 종류중 traces를 사용하려면 tempo data가 필요하다. 공식 피셜.

[https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/](https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/)